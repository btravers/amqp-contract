name: CI
permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Check formatting
        run: pnpm format --check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run linter
        run: pnpm lint

  sort-package-json:
    name: Sort package.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Check package.json sorting
        run: pnpm sort-package-json --check

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run type check
        run: pnpm typecheck

  knip:
    name: Knip
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run knip
        run: pnpm exec knip --reporter github-actions

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run tests
        run: pnpm test -- --coverage --reporter=default --reporter=github-actions

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: ./**/coverage/
          retention-days: 30

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache Docker images
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images
          key: ${{ runner.os }}-docker-${{ hashFiles('packages/testing/src/global-setup.ts') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Load cached Docker image
        run: |
          if [ -f /tmp/docker-images/rabbitmq.tar ]; then
            echo "Loading RabbitMQ image from cache..."
            docker load -i /tmp/docker-images/rabbitmq.tar
          else
            echo "No cached image found, will pull from Docker Hub"
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull and cache RabbitMQ image
        run: |
          IMAGE_NAME="rabbitmq:4.2.1-management-alpine"

          # Check if image exists locally
          if ! docker image inspect "$IMAGE_NAME" > /dev/null 2>&1; then
            echo "Pulling RabbitMQ image from Docker Hub..."
            docker pull "$IMAGE_NAME"

            # Save image to cache
            mkdir -p /tmp/docker-images
            echo "Saving image to cache..."
            docker save "$IMAGE_NAME" -o /tmp/docker-images/rabbitmq.tar
          else
            echo "RabbitMQ image already available locally"
          fi

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run integration tests
        run: pnpm test:integration -- --coverage --reporter=default --reporter=github-actions

      - name: Upload Integration Coverage Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: integration-coverage-report
          path: ./**/coverage/
          retention-days: 30
