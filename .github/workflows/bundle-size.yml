name: Bundle Size Check

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches: [main]

jobs:
  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build packages
        run: pnpm build

      - name: Check bundle sizes
        run: |
          echo "## Bundle Sizes ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | CJS | ESM |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|-----|" >> $GITHUB_STEP_SUMMARY

          prev_pkg=""
          cjs_col=""
          esm_col=""

          for pkg in packages/*/dist/index.{cjs,mjs}; do
            if [ -f "$pkg" ]; then
              size=$(du -h "$pkg" | cut -f1)
              gzip_size=$(gzip -c "$pkg" | wc -c | numfmt --to=iec-i --suffix=B)
              pkg_name=$(echo "$pkg" | cut -d'/' -f2)
              pkg_type=$(echo "$pkg" | grep -o '\(cjs\|mjs\)$')

              if [ "$pkg_name" != "$prev_pkg" ] && [ -n "$prev_pkg" ]; then
                if [ -z "$cjs_col" ]; then
                  cjs_col="N/A"
                fi
                if [ -z "$esm_col" ]; then
                  esm_col="N/A"
                fi
                echo "| $prev_pkg | $cjs_col | $esm_col |" >> $GITHUB_STEP_SUMMARY
                cjs_col=""
                esm_col=""
              fi

              if [ "$pkg_type" = "cjs" ]; then
                cjs_col="$size ($gzip_size gzipped)"
              else
                esm_col="$size ($gzip_size gzipped)"
              fi

              prev_pkg="$pkg_name"
            fi
          done

          if [ -n "$prev_pkg" ]; then
            if [ -z "$cjs_col" ]; then
              cjs_col="N/A"
            fi
            if [ -z "$esm_col" ]; then
              esm_col="N/A"
            fi
            echo "| $prev_pkg | $cjs_col | $esm_col |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
